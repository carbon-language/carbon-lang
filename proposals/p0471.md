# Extending `while` loops with exit-conditional statements

<!--
Part of the Carbon Language project, under the Apache License v2.0 with LLVM
Exceptions. See /LICENSE for license information.
SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
-->

[Pull request](https://github.com/carbon-language/carbon-lang/pull/471)

<!-- toc -->

## Table of contents

-   [Problem](#problem)
-   [Background](#background)
-   [Proposal](#proposal)
-   [Details](#details)
-   [Rationale based on Carbon's goals](#rationale-based-on-carbons-goals)
-   [Alternatives considered](#alternatives-considered)

<!-- tocstop -->

## Problem

The traditional iteration loops `while` and `for` in C and C++ suffer from a
minor short-coming that I would like to avoid in Carbon: these loops discard the
outcome of the continuation condition check. Some languages (such as Python)
solve this by providing an optional `else` statement. Backporting that approach
to C or C++ is hard, because the obvious `while ... else` syntax already has a
(different) meaning in those languages, but in a new language such as Carbon we
can provide this functionality from the start. It will be one of those details
where Carbon is both familiar to C++ users, and also a pleasant improvement over
it.

Non-problem: We are not proposing to provide syntactic sugar for every
conceivable control flow. The proposal addresses only one key issue that is both
realistic (that is it comes up somewhat regularly in real code) and for which
workarounds are unappealing.

## Background

Many structured programming languages have an iteration control flow structure
like the `while` loop. In pseudo-code, `while (condition) { BODY; }` can be
thought of as the following sequence of jumps:

```
start:
  if (condition) {
    BODY;
    goto start;
  }
end:
```

So far, so simple. However, a loop can also exit by way of something like a
`break` statement inside the body, which acts like `goto end;`. Consequently,
the `end:` label can be reached in two different ways (by flowing into it and by
`goto`), which are known to the execution, but the distinction is not available
to the programmer. Also, the body may contain a `continue` statement that acts
like `goto start;`.

Following Python's design, we propose an optional subsequent statement called
`else` that is the `else` arm of the notional `if (condition)` statement. That
is, `while (condition) { BODY; } else { ELSE-BODY; }` becomes:

```
start:
  if (condition) {
    BODY;
    goto start;
  } else {
    ELSE-BODY;
  }
end:
```

It is an open question whether `break` and `continue` statements inside the
`else` arm are a) ill-formed, b) appertain to the loop itself (`break` leaves
the block; `continue` restarts the loop), or c) are not part of the loop and
could potentially refer to a containing statement. Ill-formedness would be
easiest to understand but is perhaps needlessly restrictive. Having to
contemplate options (b) and (c) is perhaps burdensome for the reader.

## Proposal

We propose to make the syntax `while (condition) statement else statement`
valid, with the semantics described above. Consequently, `for`-loop syntax
`for (...) statement else statement` should also become available.

## Details

The proposal should be implementable with a few simple changes to the language
grammar and semantics, and the implementation should be straight-forward (since
all the constituent pieces should already be available and this corresponds
essentially to a frontend-only construction).

## Rationale based on Carbon's goals

I consider this proposal to be motivated by Carbon's goal to show what a better
C++ could look like. Specifically, it addresses the following goals.

-   "Provide the developer control over every aspect of performance." (The
    feature allows reusing an already computed value.)
-   "Excellent ergonomics." (The feature reuses existing syntax in a consistent
    way, notwithstanding debate about how intuitive or learnable it is.)
-   "Focus on encouraging appropriate usage of features rather than restricting
    misuse." (There are common code patterns that benefit from the proposed
    facility.)

## Alternatives considered

There has been a lot of discussion on this particular part of the language in
C++ for a long time. Given that the straight-up `while ... else` syntax is not
available, multiple proposals have gone much further and asked for further
optional blocks to be called from a `break`, and from a `continue`, and there
have also been multiple proposals for various kinds of "labelled breaks" where a
`break` can exit a different containing loop other than the immediate one.

I consider such an extended "control flow zoo" unnecessary: Their use cases are
increasingly narrow, and the workaround is often straight-forward and not overly
burdensome. In detail, consider that an optional landing block for, say,
`break`, could currently be written by moving the optional code to just before
the `break` statement. Only when there are multiple `breaks` would this be an
issue at all, and even then, it may be possible to refactor the code reasonably.
Assuming style guidance that loops should generally be short and simple, I
expect that only very little code would really benefit from such extended
optional control structures.

In other worlds, I consider "on break" and "on continue" blocks pure syntactic
sugar with very limited use and only minor potential for improvement, and it
would require significant syntactic novelty. By contrast, the simple
`while ... else` block fits naturally into existing syntax and exposes
information that simply would not be available to the programmer otherwise.

TODO: add list of C++ proposal papers

TODO: add survey of other languages
