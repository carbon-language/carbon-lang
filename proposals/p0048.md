# Add stacked pull request workflow

<!--
Part of the Carbon Language project, under the Apache License v2.0 with LLVM
Exceptions. See /LICENSE for license information.
SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
-->

- **Status:** WIP
- **Created:** 2020-05-27

**_PLEASE_ DO NOT SHARE OUTSIDE CARBON FORUMS**

## Problem

We want to encourage incremental development on Carbon through small, focused
changes. These are best reviewed in the form of GitHub pull requests.

However, the tooling for GitHub pull requests does not immediately support
creating meaningful code review views when pull requests are stacked in this
way.

## Background

- https://help.github.com/en/github/collaborating-with-issues-and-pull-requests/about-pull-requests
- https://help.github.com/en/github/collaborating-with-issues-and-pull-requests/creating-a-pull-request-from-a-fork
- https://help.github.com/en/github/collaborating-with-issues-and-pull-requests/changing-the-base-branch-of-a-pull-request

## Proposal

Add a specific
[workflow](../docs/project/pull_request_workflow.md#stacking-dependent-pull-requests)
to enable meaningful review of stacked pull requests by creating tracking
branches in the upstream Carbon repository at the relevant baseline pull
request. These branches can serve as baselines in the GitHub pull request flow.

### Using branches in this way is a compromise

This requires contributors who want a stacked series of pull requests to be
reviewable to have access to creating branches in the upstream repository. This
isn't something that anyone can do. However, this seems an acceptable
compromise:

- Non-stacked pull requests (the likely common initial form) have no issue. And
  it isn't necessary to know ahead of time that stacking will be desirable.

- Stacked pull requests only need this once more thanthe first one is under
  review, allowing contributors to push a stacked set of pull requests and
  afterward have necessary baseline branches created to smooth the review.

- Tracking branches can be completely managed by reviewers if necessary.

- GitHub permissions make it safe and relatively easy to have reasonably wide
  access to creating branches in a repository without allowing arbitrary changes
  to the `master` branch.

## Alternatives considered

### Use branches in the main repository for stacked pull requests

We could simply use branches in the ain repository rather than in a fork for
stacked pull requests.

Pros:

- No need to have separate tracking branches -- the pull request itself is a
  branch that can serve as a baseline.

Cons:

- Need to know _ahead of time_ when a pull request will end up as the baseline
  for another pull request. This seems somewhere between difficult and
  impossible.

  - Completely unable to address when a reviewer requests splitting up a pull
    request without starting over.
  - Likely to result in lots of churn in pull request numbers which we are using
    for things like proposals as they are moved from one form to another.

- Larger difference in workflow between non-stacked and stacked.

- Larger difference in workflow from typical, distributed GitHub flows.

- Requires permission to create a branch before _creating_ a stacked set of pull
  requests.

### Don't use stacked pull requests

We could simply discourage this practice given the lack of direct support in
fork-based development flows on GitHub.

Pros:

- Best aligned with GitHub's optimized flows.

- Simplest option.

Cons:

- Will add direct friction to keeping changse small and incremental.

- Makes splitting up pull requests based on code review more difficult.

- Lessens the ability of contributors to absorb the long latency in both code
  review across timezones and larger decision making process when needed.
