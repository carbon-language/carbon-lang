# Comments

<!--
Part of the Carbon Language project, under the Apache License v2.0 with LLVM
Exceptions. See /LICENSE for license information.
SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
-->

[Pull request](https://github.com/carbon-language/carbon-lang/pull/198)

<!-- toc -->

## Table of contents

-   [Problem](#problem)
-   [Background](#background)
    -   [Line comments](#line-comments)
    -   [Block comments](#block-comments)
    -   [`#if 0`](#if-0)
-   [Proposal](#proposal)
-   [Details](#details)
    -   [Overview](#overview)
    -   [Block comments](#block-comments-1)
        -   [Block comments rationale](#block-comments-rationale)
    -   [Reserved comments](#reserved-comments)
        -   [Reserved comments rationale](#reserved-comments-rationale)
-   [Alternatives considered](#alternatives-considered)
    -   [Intra-line comments](#intra-line-comments)
    -   [Multi-line text comments](#multi-line-text-comments)
    -   [Block comments](#block-comments-2)
    -   [Documentation comments](#documentation-comments)
    -   [Code folding comments](#code-folding-comments)

<!-- tocstop -->

## Problem

This proposal provides a suggested concrete lexical syntax for comments.

## Background

This proposal assumes the purpose and necessity of a comment syntax is
understood and uncontroversial.

In C++, there are three different ways in which comments are expressed in
practice:

### Line comments

Single-line comments (and sometimes multiline comments) are expressed in C++
using `// ...`:

```
// The next line declares a variable.
int n; // This is a comment about 'n'.
```

(These are sometimes called "BCPL comments".)

-   Can appear anywhere (at the start of a line or after tokens).
-   Can contain any text (other than newline).
-   End at the end of the logical line.
-   Can be continued by ending the comment with `\` (or `??/` in C++14 and
    earlier).
-   Unambiguous with non-comment syntax.
-   "Nest" in that `//` within `//` has no effect.
-   Do not nest with other kinds of comment.

### Block comments

Comments within lines (or sometimes multiline comments) are expressed in C++
using `/*...*/`:

```
f(/*size*/5, /*initial value*/1);
```

-   Can appear anywhere (at the start of a line or after tokens).
-   Can contain any text (other than `*/`).
-   End at the `*/` delimiter (which might be separated by a `\` line
    continuation).
-   Ambiguous with non-comment syntax: `int a=1, *b=&a, c=a/*b;` though this is
    not a problem in practice.
-   Do not nest -- the first `*/` ends the comment.

### `#if 0`

Blocks of code are often commented out in C++ programs using `#if 0`:

```
#if 0
int n;
#endif
```

-   Can appear only at the start of a logical line.
-   Can only contain sequences of preprocessing tokens (including invalid tokens
    such as `'`, but not including unterminated multiline string literals).
-   End at the matching `#endif` delimiter.
-   Unambiguous with any other syntax.
-   Nest properly, and can have other kinds of comments nested within.

## Proposal

We provide only one kind of comment, which starts with `//` and runs to the end
of the line. No code is permitted prior to a comment on the same line, and the
`//` introducing the comment is required to be followed by whitespace.

## Details

### Overview

A _comment_ is a lexical element beginning with the characters `//` and running
to the end of the line. We have no mechanism for physical line continuation, so
a trailing `\` does not extend a comment to subsequent lines.

> _Experimental:_ There can be no text other than horizontal whitespace before
> the `//` characters introducing a comment. Either all of a line is a comment,
> or none of it.

The character after the `//` is required to be a whitespace character. Newline
is a whitespace character, so a line containing only `//` is a valid comment.
The end of the file also constitutes whitespace.

All comments are removed prior to formation of tokens.

Example:

```carbon
// This is a comment and is ignored. \
This is not a comment.

var Int: x; // error, trailing comments not allowed
```

### Block comments

> _Experimental:_ No support for block comments is provided. Commenting out
> larger regions of human-readable text or code is accomplished by commenting
> out every line in the region.

#### Block comments rationale

It is important to be able to comment out a block of Carbon code, or a large
region of human-readable text. The anticipated use cases include:

-   commenting out larger passages of documentation,
-   commenting out work-in-progress code during development, and
-   performing test case reduction when isolating compiler bugs.

Note that the former use case would be addressed by including a
[separate mechanism](#documentation-comments) for representing documentation,
and the latter two use cases are generally expected to be relative rare,
transient -- not checked into version control -- and to be used only to comment
out code, not human-readable text.

These use cases can be addressed with line comments, by commenting out each line
in the intended region. That may be cumbersome, but it's unclear whether that
burden is sufficient to warrant introducing a new form of comment into the
language. By providing no such form of comments, we aim to discover if the
resulting friction warrants a language addition.

### Reserved comments

Comments in which the `//` characters are not followed by whitespace are
reserved for future extension. Anticipated possible extensions are block
comments, documentation comments, and code folding region markers.

#### Reserved comments rationale

We anticipate the possibility of adding additional kinds of comment in the
future. Reserving syntactic space in comment syntax, in a way that is easy for
programs to avoid, allows us to add such additional kinds of comment as a
non-breaking change.

## Alternatives considered

### Intra-line comments

We could include a feature similar to C-style block comments, as a way to
provide comments that attach to some element of the program smaller than a line.
In C++ code, such comments are frequently used to annotate function parameter
names:

```
render(/*use_world_coords=*/true, /*draw_frame=*/false);
```

We expect this need to be addressed by a different mechanism in Carbon, such as
named parameters or annotation syntax.

We could permit trailing comments on a line that contains other content. Such
comments are most frequently used in our sample C++ corpus to describe the
meaning of an entity, label, or close brace on the same line:

```
namespace N {
int n; // number of hats
enum Mode {
  mode1, // first mode
  mode2 // second mode
};
} // end namespace N
```

In all cases but the last, we expect it to be reasonable to move the comment to
before the declaration. For the case of an "end namespace" comment, the
underlying problem is solved in a different way, by not providing a syntax for
namespaces as delimited scopes.

Intra-line comments present a challenge for code formatting tools, which would
need to understand what part of the program syntax the comment "attaches to" in
order properly reflow the comment with the code. This concern is mitigated, but
not fully eliminated, by requiring comments to always be on their own line. We
could restrict text comments to appear in only certain syntactic locations to
fully resolve this concern, but doing so would remove the flexibility to insert
comments in arbitrary places:

```
match (x) {
  case .Foo(1, 2,
            // This might be 3 or 4 depending on the size of the Foo.
            Int: n) => { ... }
}
```

We could allow intra-line comments and still retain some idea of what the
comment syntactically attaches to by using a directionality marker in the
comment:

```
match (x) {
  case .Foo(1, 2, //> either 3 or 4 >// Int: n) => { ... }
  case .Foo(2, Int: n //< either 3 or 4 <//, 5) => { ... }
}
```

The decision to not support trailing and intra-line comments is **experimental** and should
be revisited if we find there is a need for such comments in the context of the
complete language design.

### Multi-line text comments

No support is provided for multi-line text comments. Instead, the intent is that
such comments are expressed by prepending each line with the same `// ` comment
marker.

Requiring each line to repeat the comment marker will improve readability, by
removing a source of non-local state, and removes a needless source of stylistic
variability. The resulting style of comment is common in other languages and
well-supported by editors. Even in C and C++ code that uses `/* ... */` to
comment out a block of human-readable text, it is common to include a `*` at the
start of each comment continuation line.

### Block comments

We considered various different options for block comments. Our primary goal was
to permit commenting out a large body of Carbon code, which may or may not be
well-formed (including code that contains a block comment, meaning that such
comments would need to nest). Alternatives considered included:

-   Fully line-oriented block comments, which would remove lines without regard
    for whether they are nested within a string literal, with the novel feature
    of allowing some of the contents of a block string literal to be commented
    out. This alternative has the disadvantage that it would result in
    surprising behavior inside string literals containing Carbon code.
-   Fully lexed block comments, in which a token sequence between the opening
    and closing comment marker is produced and discarded, with the lexing rules
    relaxed somewhat to avoid rejecting ill-formed code. This would be analogous
    to C and C++'s `#if 0` ... `#endif`. This alternative has the disadvantage
    that it would be inefficient to process.
-   A hybrid approach, with `//\{` and `//\}` delimiters that are invalid in
    non-raw string literals, and with an indentation requirement for raw string
    literals only. This alternative has the disadvantage of introducing
    additional complexity into the lexical rules by treating different kinds of
    string literals differently.
-   Use of `/*` and `*/` as comment markers. This alternative has the
    disadvantage that it risks confusion by using similar syntax to C and C++
    but with divergent semantics.

However, given the limited use cases for such comments, we are not pursuing any
of these options in this proposal.

### Documentation comments

We could add a distinct comment syntax for documentation comments, perhaps
treating documentation comments as producing real tokens rather than being
stripped out by the lexer. However, during discussion, there was significant
support for using a syntax that does not resemble a comment for representing
documentation. For example, we could introduce an attribute syntax, such as
using `# <expression>` as a prefix to a declaration to attach attributes. Then a
string literal attribute can be treated as documentation:

```carbon
#"Get the size of the thing."
fn GetThingSize() -> Int;

#"""
Rate the quality of the widget.

Returns a quality factor between 0.0 and 1.0.
"""
fn RateQuality(
  #"The widget to rate."
  Widget: w,
  #"A widget quality database."
  QualityDB: db) -> Float;
```

This use case will be explored by a future proposal.

### Code folding comments

Some code editors are able to "fold" regions of a source file in order to ease
navigation. In some cases, these fold regions can be customized by the use of
comment lines. For example, in VS Code, this is accomplished with comments
containing `#region` and `#endregion`:

```
// #region Functions F and G
fn f() { ... }
fn g() { ... }
// #endregion
```

Supporting such markers as normal text within line comments requires no
additional effort. However, we could consider introducing a specific Carbon
syntax for region comments, in order to encourage a common representation across
code editors. Such support is not covered by this proposal, but could be handled
by a new form of comment.
