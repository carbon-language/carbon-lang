# Clarify rules around `Self` and `.Self`

<!--
Part of the Carbon Language project, under the Apache License v2.0 with LLVM
Exceptions. See /LICENSE for license information.
SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
-->

[Pull request](https://github.com/carbon-language/carbon-lang/pull/2107)

<!-- toc -->

## Table of contents

-   [Abstract](#abstract)
-   [Problem](#problem)
-   [Background](#background)
-   [Proposal](#proposal)
-   [Details](#details)
-   [Rationale](#rationale)
-   [Alternatives considered](#alternatives-considered)
    -   [`Self` not a keyword](#self-not-a-keyword)
    -   [`where` operator could be associative](#where-operator-could-be-associative)

<!-- tocstop -->

## Abstract

A number of smaller changes grouped together in one proposal:

-   Make `Self` a keyword.
-   Clarify that `Self` always refers to the current type, even for virtual
    functions implemented in a derived class.
-   Clarify when `.Self` is legal, and what type it has.
-   Also specify that `where` is not an associative operator.

## Problem

TODO: What problem are you trying to solve? How important is that problem? Who
is impacted by it?

## Background

TODO: Is there any background that readers should consider to fully understand
this problem and your approach to solving it?

The type of `.Self` and where it would be introduced grammatically was discussed
[#generics channel on Discord on 2022-06-07](https://discord.com/channels/655572317891461132/708431657849585705/1013904969335836732).

## Proposal

This proposal implements a number of changes and clarifications about the use of
`Self` and `.Self` with generics:

-   `Self` is now a keyword, and may not be used as an identifier even in
    contexts where `Self` has no meaning. If `Self` is used in a C++ API, Carbon
    will use the same mechanism for interop as other Carbon keywords.

TODO: Briefly and at a high level, how do you propose to solve the problem? Why
will that in fact solve it?

## Details

TODO: Fully explain the details of the proposed solution.

## Rationale

TODO: How does this proposal effectively advance Carbon's goals? Rather than
re-stating the full motivation, this should connect that motivation back to
Carbon's stated goals and principles. This may evolve during review. Use links
to appropriate sections of [`/docs/project/goals.md`](/docs/project/goals.md),
and/or to documents in [`/docs/project/principles`](/docs/project/principles).
For example:

-   [Community and culture](/docs/project/goals.md#community-and-culture)
-   [Language tools and ecosystem](/docs/project/goals.md#language-tools-and-ecosystem)
-   [Performance-critical software](/docs/project/goals.md#performance-critical-software)
-   [Software and language evolution](/docs/project/goals.md#software-and-language-evolution)
-   [Code that is easy to read, understand, and write](/docs/project/goals.md#code-that-is-easy-to-read-understand-and-write)
-   [Practical safety and testing mechanisms](/docs/project/goals.md#practical-safety-and-testing-mechanisms)
-   [Fast and scalable development](/docs/project/goals.md#fast-and-scalable-development)
-   [Modern OS platforms, hardware architectures, and environments](/docs/project/goals.md#modern-os-platforms-hardware-architectures-and-environments)
-   [Interoperability with and migration from existing C++ code](/docs/project/goals.md#interoperability-with-and-migration-from-existing-c-code)

## Alternatives considered

TODO: What alternative solutions have you considered?

### `Self` not a keyword

An alternative considered was forbidding identifiers to be equal to `Self`, but
that wouldn't be how we would add `Self` to the language. We would automatically
update the code to change existing uses of `Self` to the raw identifier syntax.
Note that at this time
[no raw identifier syntax has been approved](https://github.com/carbon-language/carbon-lang/pull/93),
but Rust uses a `r#` prefix. If Carbon used the same syntax, existing uses of
`Self` would be changed to `r#Self`, and so `r#Self` should still be a legal
identifier.

### `where` operator could be associative

We considered making the `where` operator associative, since an expression like

```
Interface1 where .AssocType1 is Interface2 where .AssocType2 == .Self
```

would more usefully be interpreted as:

```
Interface1 where .AssocType1 is (Interface2 where .AssocType2 == .Self)
```

than the alternative. However, this is expected to be a rare case and so it
seemed much friendlier to humans to require parentheses. This way they can
easily visually disambiguate how it is interpreted without having to remember a
rule that won't commonly be relevant.

This was discussed in
[the #syntax channel on Discord on 2022-05-27](https://discord.com/channels/655572317891461132/709488742942900284/979869282903130153)
and
[the weekly sync meeting on 2022-06-01](https://docs.google.com/document/d/1dwS2sJ8tsN3LwxqmZSv9OvqutYhP71dK9Dmr1IXQFTs/edit?resourcekey=0-NxBWgL9h05yD2GOR3wUisg#heading=h.qarzfirrcrgf).
