# This tests verifies functionality of omagic that we create only two segments,
# PT_LOAD, PT_TLS
# The data segment should not be aligned to a page boundary
RUN: lld -flavor gnu -target x86_64-linux %p/Inputs/nmagic.o  \
RUN: --noinhibit-exec -o %t --omagic
RUN: llvm-readobj -sections %t | FileCheck -check-prefix=OMAGICSECTIONS %s
RUN: llvm-readobj -program-headers %t | FileCheck -check-prefix=OMAGICPROGRAMHEADERS %s

OMAGICSECTIONS: Sections [
OMAGICSECTIONS:   Section {
OMAGICSECTIONS:     Index: 0
OMAGICSECTIONS:     Name:  (0)
OMAGICSECTIONS:     Type: SHT_NULL (0x0)
OMAGICSECTIONS:     Flags [ (0x0)
OMAGICSECTIONS:     ]
OMAGICSECTIONS:     Address: 0x0
OMAGICSECTIONS:     Offset: 0x0
OMAGICSECTIONS:     Size: 0
OMAGICSECTIONS:     Link: 0
OMAGICSECTIONS:     Info: 0
OMAGICSECTIONS:     AddressAlignment: 0
OMAGICSECTIONS:     EntrySize: 0
OMAGICSECTIONS:   }
OMAGICSECTIONS:   Section {
OMAGICSECTIONS:     Index: 1
OMAGICSECTIONS:     Name: .text (1)
OMAGICSECTIONS:     Type: SHT_PROGBITS (0x1)
OMAGICSECTIONS:     Flags [ (0x6)
OMAGICSECTIONS:       SHF_ALLOC (0x2)
OMAGICSECTIONS:       SHF_EXECINSTR (0x4)
OMAGICSECTIONS:     ]
OMAGICSECTIONS:     Address: 0x4000B0
OMAGICSECTIONS:     Offset: 0xB0
OMAGICSECTIONS:     Size: 11
OMAGICSECTIONS:     Link: 0
OMAGICSECTIONS:     Info: 0
OMAGICSECTIONS:     AddressAlignment: 4
OMAGICSECTIONS:     EntrySize: 0
OMAGICSECTIONS:   }
OMAGICSECTIONS:   Section {
OMAGICSECTIONS:     Index: 2
OMAGICSECTIONS:     Name: .note.GNU-stack (7)
OMAGICSECTIONS:     Type: SHT_PROGBITS (0x1)
OMAGICSECTIONS:     Flags [ (0x2)
OMAGICSECTIONS:       SHF_ALLOC (0x2)
OMAGICSECTIONS:     ]
OMAGICSECTIONS:     Address: 0x4000BB
OMAGICSECTIONS:     Offset: 0xBB
OMAGICSECTIONS:     Size: 0
OMAGICSECTIONS:     Link: 0
OMAGICSECTIONS:     Info: 0
OMAGICSECTIONS:     AddressAlignment: 1
OMAGICSECTIONS:     EntrySize: 0
OMAGICSECTIONS:   }
OMAGICSECTIONS:   Section {
OMAGICSECTIONS:     Index: 3
OMAGICSECTIONS:     Name: .comment (23)
OMAGICSECTIONS:     Type: SHT_PROGBITS (0x1)
OMAGICSECTIONS:     Flags [ (0x2)
OMAGICSECTIONS:       SHF_ALLOC (0x2)
OMAGICSECTIONS:     ]
OMAGICSECTIONS:     Address: 0x4000BB
OMAGICSECTIONS:     Offset: 0xBB
OMAGICSECTIONS:     Size: 43
OMAGICSECTIONS:     Link: 0
OMAGICSECTIONS:     Info: 0
OMAGICSECTIONS:     AddressAlignment: 1
OMAGICSECTIONS:     EntrySize: 0
OMAGICSECTIONS:   }
OMAGICSECTIONS:   Section {
OMAGICSECTIONS:     Index: 4
OMAGICSECTIONS:     Name: .eh_frame (32)
OMAGICSECTIONS:     Type: SHT_PROGBITS (0x1)
OMAGICSECTIONS:     Flags [ (0x2)
OMAGICSECTIONS:       SHF_ALLOC (0x2)
OMAGICSECTIONS:     ]
OMAGICSECTIONS:     Address: 0x4000E8
OMAGICSECTIONS:     Offset: 0xE8
OMAGICSECTIONS:     Size: 56
OMAGICSECTIONS:     Link: 0
OMAGICSECTIONS:     Info: 0
OMAGICSECTIONS:     AddressAlignment: 8
OMAGICSECTIONS:     EntrySize: 0
OMAGICSECTIONS:   }
OMAGICSECTIONS:   Section {
OMAGICSECTIONS:     Index: 5
OMAGICSECTIONS:     Name: .tdata (42)
OMAGICSECTIONS:     Type: SHT_PROGBITS (0x1)
OMAGICSECTIONS:     Flags [ (0x403)
OMAGICSECTIONS:       SHF_ALLOC (0x2)
OMAGICSECTIONS:       SHF_TLS (0x400)
OMAGICSECTIONS:       SHF_WRITE (0x1)
OMAGICSECTIONS:     ]
OMAGICSECTIONS:     Address: 0x400120
OMAGICSECTIONS:     Offset: 0x120
OMAGICSECTIONS:     Size: 4
OMAGICSECTIONS:     Link: 0
OMAGICSECTIONS:     Info: 0
OMAGICSECTIONS:     AddressAlignment: 4
OMAGICSECTIONS:     EntrySize: 0
OMAGICSECTIONS:   }
OMAGICSECTIONS:   Section {
OMAGICSECTIONS:     Index: 6
OMAGICSECTIONS:     Name: .tbss (49)
OMAGICSECTIONS:     Type: SHT_NOBITS (0x8)
OMAGICSECTIONS:     Flags [ (0x403)
OMAGICSECTIONS:       SHF_ALLOC (0x2)
OMAGICSECTIONS:       SHF_TLS (0x400)
OMAGICSECTIONS:       SHF_WRITE (0x1)
OMAGICSECTIONS:     ]
OMAGICSECTIONS:     Address: 0x400124
OMAGICSECTIONS:     Offset: 0x124
OMAGICSECTIONS:     Size: 8
OMAGICSECTIONS:     Link: 0
OMAGICSECTIONS:     Info: 0
OMAGICSECTIONS:     AddressAlignment: 4
OMAGICSECTIONS:     EntrySize: 0
OMAGICSECTIONS:   }
OMAGICSECTIONS:   Section {
OMAGICSECTIONS:     Index: 7
OMAGICSECTIONS:     Name: .got.plt (55)
OMAGICSECTIONS:     Type: SHT_PROGBITS (0x1)
OMAGICSECTIONS:     Flags [ (0x3)
OMAGICSECTIONS:       SHF_ALLOC (0x2)
OMAGICSECTIONS:       SHF_WRITE (0x1)
OMAGICSECTIONS:     ]
OMAGICSECTIONS:     Address: 0x400128
OMAGICSECTIONS:     Offset: 0x128
OMAGICSECTIONS:     Size: 0
OMAGICSECTIONS:     Link: 0
OMAGICSECTIONS:     Info: 0
OMAGICSECTIONS:     AddressAlignment: 8
OMAGICSECTIONS:     EntrySize: 0
OMAGICSECTIONS:   }
OMAGICSECTIONS:   Section {
OMAGICSECTIONS:     Index: 8
OMAGICSECTIONS:     Name: .data (64)
OMAGICSECTIONS:     Type: SHT_PROGBITS (0x1)
OMAGICSECTIONS:     Flags [ (0x3)
OMAGICSECTIONS:       SHF_ALLOC (0x2)
OMAGICSECTIONS:       SHF_WRITE (0x1)
OMAGICSECTIONS:     ]
OMAGICSECTIONS:     Address: 0x400128
OMAGICSECTIONS:     Offset: 0x128
OMAGICSECTIONS:     Size: 4
OMAGICSECTIONS:     Link: 0
OMAGICSECTIONS:     Info: 0
OMAGICSECTIONS:     AddressAlignment: 4
OMAGICSECTIONS:     EntrySize: 0
OMAGICSECTIONS:   }
OMAGICSECTIONS:   Section {
OMAGICSECTIONS:     Index: 9
OMAGICSECTIONS:     Name: .bss (70)
OMAGICSECTIONS:     Type: SHT_NOBITS (0x8)
OMAGICSECTIONS:     Flags [ (0x3)
OMAGICSECTIONS:       SHF_ALLOC (0x2)
OMAGICSECTIONS:       SHF_WRITE (0x1)
OMAGICSECTIONS:     ]
OMAGICSECTIONS:     Address: 0x40012C
OMAGICSECTIONS:     Offset: 0x12C
OMAGICSECTIONS:     Size: 0
OMAGICSECTIONS:     Link: 0
OMAGICSECTIONS:     Info: 0
OMAGICSECTIONS:     AddressAlignment: 4
OMAGICSECTIONS:     EntrySize: 0
OMAGICSECTIONS:   }
OMAGICSECTIONS:   Section {
OMAGICSECTIONS:     Index: 10
OMAGICSECTIONS:     Name: .shstrtab (75)
OMAGICSECTIONS:     Type: SHT_STRTAB (0x3)
OMAGICSECTIONS:     Flags [ (0x0)
OMAGICSECTIONS:     ]
OMAGICSECTIONS:     Address: 0x0
OMAGICSECTIONS:     Offset: 0x12C
OMAGICSECTIONS:     Size: 101
OMAGICSECTIONS:     Link: 0
OMAGICSECTIONS:     Info: 0
OMAGICSECTIONS:     AddressAlignment: 1
OMAGICSECTIONS:     EntrySize: 0
OMAGICSECTIONS:   }
OMAGICSECTIONS:   Section {
OMAGICSECTIONS:     Index: 11
OMAGICSECTIONS:     Name: .symtab (85)
OMAGICSECTIONS:     Type: SHT_SYMTAB (0x2)
OMAGICSECTIONS:     Flags [ (0x0)
OMAGICSECTIONS:     ]
OMAGICSECTIONS:     Address: 0x0
OMAGICSECTIONS:     Offset: 0x198
OMAGICSECTIONS:     Size: 528
OMAGICSECTIONS:     Link: 12
OMAGICSECTIONS:     Info: 2
OMAGICSECTIONS:     AddressAlignment: 8
OMAGICSECTIONS:     EntrySize: 24
OMAGICSECTIONS:   }
OMAGICSECTIONS:   Section {
OMAGICSECTIONS:     Index: 12
OMAGICSECTIONS:     Name: .strtab (93)
OMAGICSECTIONS:     Type: SHT_STRTAB (0x3)
OMAGICSECTIONS:     Flags [ (0x0)
OMAGICSECTIONS:     ]
OMAGICSECTIONS:     Address: 0x0
OMAGICSECTIONS:     Offset: 0x3A8
OMAGICSECTIONS:     Size: 246
OMAGICSECTIONS:     Link: 0
OMAGICSECTIONS:     Info: 0
OMAGICSECTIONS:     AddressAlignment: 1
OMAGICSECTIONS:     EntrySize: 0
OMAGICSECTIONS:   }
OMAGICSECTIONS: ]

OMAGICPROGRAMHEADERS: ProgramHeaders [
OMAGICPROGRAMHEADERS:   ProgramHeader {
OMAGICPROGRAMHEADERS:     Type: PT_LOAD (0x1)
OMAGICPROGRAMHEADERS:     Offset: 0x0
OMAGICPROGRAMHEADERS:     VirtualAddress: 0x400000
OMAGICPROGRAMHEADERS:     PhysicalAddress: 0x400000
OMAGICPROGRAMHEADERS:     FileSize: 300
OMAGICPROGRAMHEADERS:     MemSize: 300
OMAGICPROGRAMHEADERS:     Flags [ (0x7)
OMAGICPROGRAMHEADERS:       PF_R (0x4)
OMAGICPROGRAMHEADERS:       PF_W (0x2)
OMAGICPROGRAMHEADERS:       PF_X (0x1)
OMAGICPROGRAMHEADERS:     ]
OMAGICPROGRAMHEADERS:     Alignment: 8
OMAGICPROGRAMHEADERS:   }
OMAGICPROGRAMHEADERS:   ProgramHeader {
OMAGICPROGRAMHEADERS:     Type: PT_TLS (0x7)
OMAGICPROGRAMHEADERS:     Offset: 0x120
OMAGICPROGRAMHEADERS:     VirtualAddress: 0x400120
OMAGICPROGRAMHEADERS:     PhysicalAddress: 0x400120
OMAGICPROGRAMHEADERS:     FileSize: 4
OMAGICPROGRAMHEADERS:     MemSize: 12
OMAGICPROGRAMHEADERS:     Flags [ (0x6)
OMAGICPROGRAMHEADERS:       PF_R (0x4)
OMAGICPROGRAMHEADERS:       PF_W (0x2)
OMAGICPROGRAMHEADERS:     ]
OMAGICPROGRAMHEADERS:     Alignment: 4
OMAGICPROGRAMHEADERS:   }
OMAGICPROGRAMHEADERS: ]
