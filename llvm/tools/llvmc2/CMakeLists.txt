set(LLVM_LINK_COMPONENTS support system)
set(LLVM_REQUIRES_EH 1)

macro(tgen ofn)
  add_custom_command(OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/${ofn}
    COMMAND tblgen ${ARGN} -I ${CMAKE_CURRENT_SOURCE_DIR} -I ${CMAKE_SOURCE_DIR}/lib/Target -I ${llvm_include_path} ${CMAKE_CURRENT_SOURCE_DIR}/Graph.td -o ${ofn}
    DEPENDS
    tblgen
    ${CMAKE_CURRENT_SOURCE_DIR}/Common.td
    ${CMAKE_CURRENT_SOURCE_DIR}/Graph.td
    ${CMAKE_CURRENT_SOURCE_DIR}/Tools.td
    COMMENT "Building ${ofn}..."
    )
endmacro(tgen ofn)

tgen(AutoGenerated.inc -gen-llvmc)

add_custom_target(AutoGenerated_ct echo Tablegenning
  DEPENDS
  ${CMAKE_CURRENT_BINARY_DIR}/AutoGenerated.inc
  )

include_directories( ${CMAKE_CURRENT_BINARY_DIR} )

add_llvm_tool(llvmc2
  Action.cpp
  AutoGenerated.cpp
  CompilationGraph.cpp
  Plugin.cpp
  llvmc.cpp
  )

add_dependencies(llvmc2 AutoGenerated_ct)
